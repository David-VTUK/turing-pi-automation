apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fedora-server-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 30Gi
  volumeMode: Block
---
apiVersion: batch/v1
kind: Job
metadata:
  name: upload-fedora-server-job
spec:
  template:
    spec:
      containers:
      - name: writer
        image: fedora:latest
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            echo "[1/2] Downloading and decompressing Fedora Server image..."
            curl -L https://download.fedoraproject.org/pub/fedora/linux/releases/42/Server/aarch64/images/Fedora-Server-Host-Generic-42-1.1.aarch64.raw.xz | xz -d > /tmp/disk.raw
            echo "[2/2] Writing image to PVC block device..."
            dd if=/tmp/disk.raw of=/dev/vda bs=4M status=progress conv=fsync
            echo "âœ… Done writing Fedora Server image to PVC!"
        volumeDevices:
        - name: disk
          devicePath: /dev/vda
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        securityContext:
          runAsUser: 0
      restartPolicy: Never
      volumes:
      - name: disk
        persistentVolumeClaim:
          claimName: fedora-server-pvc
      - name: tmp
        emptyDir: {}
---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: fedora-server
spec:
  running: true
  template:
    metadata:
      labels:
        kubevirt.io/domain: fedora-server
    spec:
      domain:
        cpu:
          cores: 2
        resources:
          requests:
            memory: 2Gi
        devices:
          disks:
            - name: disk0
              disk:
                bus: virtio
            - name: cloudinitdisk
              disk:
                bus: virtio
      volumes:
        - name: disk0
          persistentVolumeClaim:
            claimName: fedora-server-pvc
        - name: cloudinitdisk
          cloudInitNoCloud:
            userData: |
              #cloud-config
              user: kube
              password: changeme
              chpasswd: { expire: false }
              ssh_authorized_keys:
                - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCn4gPvm0bEGdlfvfiwpVJgRe/gvueMXTc+E49gvwCdthyMYRzjHN1K0Y0ZuNbPI6yQestD5LLHsvOMdWjEYQpYe8TSk6qoK3fFTuXfN3XRkz36UazMSsWr8eljfGWDcw2FOGpX6zoLxibbHhzO9mjwiCbK11qAXLhAGtrsCChrACih0QH5Dr23gaVKsHpbScZN7WaNNcX1thVojt0dpgsvu7SoQLjhpnAipueGhZffaf2UEFRiRWG3Ql56U1n5xkLUDF0a/yT+/YqyEi5jdWColNCrUGt8V6UdsSE5EebCyeXY4YAdfA7ebfhth3l3DVYQ2iHCsITOxOLP0XwkZLjywmIelP9Uw5YJofW3YvsHtrKX4ML81GcCBTLGgBgj1udEjQgaNGaDrvU2LLslyDm6mAKQzaF9Iux3wWHbA8fHjZJ5SR2DTylmwbNeO5moPt4zLIeJUBsu+b01gKigSYE198EjKuzROApADeW7pzWhsK9H/IxGShMUwm1elvBXKX8TSbHQ5Gj9FVhzaoOo0fgtIlDtWd/NSbOmwC2knpDLrZQ9oW3ddyijmiTep097Mk52bzUAWocxJiUesedtV8lpEEqO3J7NGuiNdTdq8JgbdCJ9rSfediC+mrqtzfChIHpvvgp0GReo8UDyyGS7DAznPE00yy+HbBVHqqfjgoQ3Aw==
