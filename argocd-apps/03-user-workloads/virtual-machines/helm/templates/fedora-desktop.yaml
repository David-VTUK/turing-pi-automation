apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fedora-desktop-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 30Gi
  volumeMode: Block
---
apiVersion: batch/v1
kind: Job
metadata:
  name: upload-fedora-desktop-job
spec:
  template:
    spec:
      containers:
      - name: writer
        image: fedora:latest
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            echo "[1/2] Downloading and decompressing Fedora Desktop image..."
            curl -L https://download.fedoraproject.org/pub/fedora/linux/releases/42/Workstation/aarch64/images/Fedora-Workstation-Disk-42-1.1.aarch64.raw.xz | xz -d > /tmp/disk.raw
            echo "[2/2] Writing image to PVC block device..."
            dd if=/tmp/disk.raw of=/dev/vda bs=4M status=progress conv=fsync
            echo "âœ… Done writing Fedora Server desktop to PVC!"
        volumeDevices:
        - name: disk
          devicePath: /dev/vda
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        securityContext:
          runAsUser: 0
      restartPolicy: Never
      volumes:
      - name: disk
        persistentVolumeClaim:
          claimName: fedora-desktop-pvc
      - name: tmp
        emptyDir: {}
---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: fedora-desktop
spec:
  running: true
  template:
    metadata:
      labels:
        kubevirt.io/domain: fedora-desktop
    spec:
      domain:
        cpu:
          cores: 4
        resources:
          requests:
            memory: 4Gi
        devices:
          disks:
            - name: disk0
              disk:
                bus: virtio
            - name: cloudinitdisk
              disk:
                bus: virtio
      volumes:
        - name: disk0
          persistentVolumeClaim:
            claimName: fedora-desktop-pvc
        - name: cloudinitdisk
          cloudInitNoCloud:
            userData: |
              #cloud-config
              user: kube
              password: changeme
              chpasswd: { expire: false }
---
apiVersion: v1
kind: Service
metadata:
  name: fedora-desktop-access
spec:
  ports:
    - name: ssh
      port: 22      # External port
      protocol: TCP
      targetPort: 22   # Port inside the VM for SSH
  selector:
    kubevirt.io/domain: fedora-desktop
  type: LoadBalancer


